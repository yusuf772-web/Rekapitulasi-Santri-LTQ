<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapitulasi Santri</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SheetJS Library for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712; /* Slightly darker than gray-900 for better contrast */
            color: #d1d5db; /* text-gray-300 */
        }

        .card {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem;
        }

        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .rekap-table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        .rekap-table th, .rekap-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #374151;
        }

        .rekap-table th {
            background-color: #374151;
            font-weight: 600;
            color: #f9fafb;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .rekap-table tbody tr:hover {
            background-color: #2b3546;
        }

        .form-select, .form-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.625rem 1rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1f2937, 0 0 0 4px #3b82f6;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }
        .btn-primary:disabled {
            background-color: #374151;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .btn-secondary {
            background-color: #374151;
            color: #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .filter-btn-group button {
             border-radius: 0;
             border-right-width: 1px;
             border-color: #4b5563;
        }
        .filter-btn-group button:first-child { border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }
        .filter-btn-group button:last-child { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; border-right-width: 0; }
        
        .filter-btn.active {
            background-color: #3b82f6;
            color: white;
            z-index: 10;
        }
        
        .tab-btn.active {
             background-color: #3b82f6;
            color: white;
        }

        .skeleton-row {
            background-color: #374151;
            border-radius: 0.5rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            height: 49px; /* Match table row height */
            margin-bottom: 8px;
        }
        @keyframes pulse {
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-full mx-auto">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i data-lucide="bar-chart-3" class="w-6 h-6 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Rekapitulasi Santri</h1>
            </div>
            <button id="exportBtn" class="btn btn-primary" disabled>
                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                <span>Ekspor ke Excel</span>
            </button>
        </header>

        <!-- Main Filters Card -->
        <div class="card mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Filter Berdasarkan</label>
                    <div id="filterTypeContainer" class="inline-flex rounded-md shadow-sm filter-btn-group">
                        <button data-value="month" class="btn btn-secondary filter-btn active">Per Bulan</button>
                        <button data-value="range" class="btn btn-secondary filter-btn">Per Tanggal</button>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label id="dateFilterLabel" class="block text-sm font-medium text-gray-400 mb-2">Pilih Bulan & Tahun</label>
                    <div class="flex gap-4">
                        <select id="monthFilter" class="form-select w-full"></select>
                        <input type="date" id="startDateFilter" class="form-input w-full hidden">
                        <input type="date" id="endDateFilter" class="form-input w-full hidden">
                    </div>
                </div>
            </div>
        </div>

        <!-- Recap Type and Class Filters Card -->
        <div class="card mb-6">
             <!-- Recap Type Tabs -->
            <div id="recapFilterContainer" class="flex flex-wrap items-center gap-2 mb-4 border-b border-gray-700 pb-4">
                 <button data-recap="perkembangan" class="btn btn-secondary tab-btn active">Rekap Perkembangan</button>
                 <button data-recap="absen" class="btn btn-secondary tab-btn">Rekap Absen</button>
                 <button data-recap="nilai" class="btn btn-secondary tab-btn">Rekap Nilai</button>
                 <button data-recap="tasmi" class="btn btn-secondary tab-btn">Rekap Tasmi</button>
            </div>
            <!-- Class Filter Buttons -->
            <div id="classFilterContainer" class="flex flex-wrap items-center gap-2">
                 <p class="text-gray-400 mr-2">Semua Kelas:</p>
                <!-- Tombol filter kelas akan dimasukkan di sini oleh JavaScript -->
            </div>
        </div>


        <!-- Table Card -->
        <div class="card">
            <div class="table-wrapper">
                <div id="rekapLoader" class="p-4">
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                </div>
                <table id="rekapTable" class="rekap-table hidden">
                    <thead id="rekapTableHead">
                        <!-- Header will be injected by JavaScript -->
                    </thead>
                    <tbody id="rekapTableBody">
                        <!-- Rows will be injected by JavaScript -->
                    </tbody>
                </table>
                 <div id="emptyState" class="hidden text-center py-16">
                    <i data-lucide="folder-search" class="w-16 h-16 mx-auto text-gray-500"></i>
                    <p class="mt-4 text-lg font-semibold">Tidak Ada Data</p>
                    <p class="text-gray-400">Pilih kelas untuk menampilkan data atau tidak ada data pada periode ini.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBzvOsp5EVnzTI8Kbew9nXSXXLpakBD6Ec",
            authDomain: "ltq-hn.firebaseapp.com",
            projectId: "ltq-hn",
            storageBucket: "ltq-hn.appspot.com",
            messagingSenderId: "542731528480",
            appId: "1:542731528480:web:15203f68716ed2e3dacf45"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let currentUserId = null;
        let unsubscribes = {};
        let allStudents = [];
        let allMentors = [];
        let allHalaqohGroups = [];
        let allClasses = [];
        let compiledRecapData = [];
        let activeClassFilter = null;
        let activeRecapFilter = 'perkembangan';

        // --- DOM Elements ---
        const dom = {
            filterTypeContainer: document.getElementById('filterTypeContainer'),
            monthFilter: document.getElementById('monthFilter'),
            startDateFilter: document.getElementById('startDateFilter'),
            endDateFilter: document.getElementById('endDateFilter'),
            dateFilterLabel: document.getElementById('dateFilterLabel'),
            exportBtn: document.getElementById('exportBtn'),
            rekapTable: document.getElementById('rekapTable'),
            rekapTableHead: document.getElementById('rekapTableHead'),
            rekapTableBody: document.getElementById('rekapTableBody'),
            rekapLoader: document.getElementById('rekapLoader'),
            emptyState: document.getElementById('emptyState'),
            classFilterContainer: document.getElementById('classFilterContainer'),
            recapFilterContainer: document.getElementById('recapFilterContainer'),
        };
        
        // --- Recap View Configuration ---
        const recapViews = {
            perkembangan: {
                title: "Rekap Perkembangan",
                columns: ["No", "Nama Santri", "Kelas", "Nama Pembimbing", "Total Hafalan", "Hafalan Terakhir", "Jml Halaman Ziyadah", "Jml Halaman Murojaah", "Nilai Itqon", "Nilai Tajwid", "Alfa", "Izin", "Sakit", "Jumlah Hafalan Tasmi", "Hasil Terakhir Tasmi", "Tanggal Terakhir Tasmi"],
                dataKeys: ["namaSantri", "kelas", "namaPembimbing", "totalHafalan", "hafalanTerakhir", "ziyadah", "murojaah", "nilaiItqon", "nilaiTajwid", "alfa", "izin", "sakit", "jumlahHafalanTasmi", "hasilTasmi", "tanggalTasmi"]
            },
            absen: {
                title: "Rekap Absen",
                columns: ["No", "Nama Santri", "Kelas", "Nama Pembimbing", "Alfa", "Izin", "Sakit"],
                dataKeys: ["namaSantri", "kelas", "namaPembimbing", "alfa", "izin", "sakit"]
            },
            nilai: {
                title: "Rekap Nilai",
                columns: ["No", "Nama Santri", "Kelas", "Nama Pembimbing", "Rata-rata Itqon", "Rata-rata Tajwid"],
                dataKeys: ["namaSantri", "kelas", "namaPembimbing", "avgItqon", "avgTajwid"]
            },
            tasmi: {
                title: "Rekap Tasmi",
                columns: ["No", "Nama Santri", "Kelas", "Nama Pembimbing", "Tanggal Tasmi", "Jumlah Hafalan", "Keterangan"],
                dataKeys: ["namaSantri", "kelas", "namaPembimbing", "tanggalTasmi", "jumlahHafalanTasmi", "hasilTasmi"]
            }
        };

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                preloadData();
            } else {
                try {
                    await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
                } catch (error) {
                    console.error("Authentication error:", error);
                }
            }
        });

        // --- Data Fetching and Processing ---
        function preloadData() {
            const collectionsToLoad = {
                students: 'students',
                mentors: 'mentors',
                halaqohGroups: 'halaqohGroups',
                classes: 'classes',
            };

            let dataLoadedCount = 0;
            const totalCollections = Object.keys(collectionsToLoad).length;

            Object.entries(collectionsToLoad).forEach(([stateKey, collectionName]) => {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', collectionName));
                unsubscribes[stateKey] = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (stateKey === 'students') allStudents = data;
                    if (stateKey === 'mentors') allMentors = data;
                    if (stateKey === 'halaqohGroups') allHalaqohGroups = data;
                    if (stateKey === 'classes') {
                        allClasses = data;
                        populateClassFilterButtons();
                    }
                    dataLoadedCount++;
                    if (dataLoadedCount === totalCollections) {
                        populateMonthFilter();
                        dom.rekapTable.classList.add('hidden');
                        dom.rekapLoader.style.display = 'none';
                        dom.emptyState.classList.remove('hidden');
                    }
                });
            });
        }

        function fetchRecapData() {
            if (activeClassFilter === null) {
                dom.rekapLoader.style.display = 'none';
                dom.emptyState.classList.remove('hidden');
                dom.rekapTable.classList.add('hidden');
                dom.exportBtn.disabled = true;
                return;
            }

            let startDate, endDate;
            const filterType = document.querySelector('#filterTypeContainer .filter-btn.active').dataset.value;

            if (filterType === 'month') {
                const [year, month] = dom.monthFilter.value.split('-').map(Number);
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0, 23, 59, 59);
            } else { // 'range'
                startDate = new Date(dom.startDateFilter.value + 'T00:00:00');
                endDate = new Date(dom.endDateFilter.value + 'T23:59:59');
            }
            
            dom.rekapTable.classList.add('hidden');
            dom.emptyState.classList.add('hidden');
            dom.rekapLoader.style.display = 'block';
            dom.exportBtn.disabled = true;

            const startTimestamp = Timestamp.fromDate(startDate);
            const endTimestamp = Timestamp.fromDate(endDate);

            const submissionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'formSubmissions');
            const q = query(submissionsRef, where('timestamp', '>=', startTimestamp), where('timestamp', '<=', endTimestamp));

            if (unsubscribes.submissions) unsubscribes.submissions();
            unsubscribes.submissions = onSnapshot(q, (snapshot) => {
                const submissions = snapshot.docs.map(doc => doc.data());
                compileData(submissions);
            }, (error) => {
                console.error("Error fetching submissions:", error);
                compileData([]);
            });
        }
        
        // --- Data Compilation ---
        function compileData(submissions) {
            if (activeRecapFilter === 'tasmi') {
                compileTasmiData(submissions);
            } else {
                compileStandardData(submissions);
            }
            renderTable();
        }

        function compileTasmiData(submissions) {
            compiledRecapData = [];
            const tasmiSubmissions = submissions.filter(s => s.formType === 'form2');

            for (const submission of tasmiSubmissions) {
                const student = allStudents.find(s => s.name === submission.namaSantri2);
                if (!student) continue;

                if (activeClassFilter !== 'all' && student.class !== activeClassFilter) {
                    continue;
                }

                const group = allHalaqohGroups.find(g => g.studentIds?.includes(student.id));
                const mentor = allMentors.find(m => m.id === group?.mentorId);

                compiledRecapData.push({
                    namaSantri: student.name,
                    kelas: student.class || '-',
                    namaPembimbing: mentor?.name || submission.namaPembimbing2 || '-',
                    jumlahHafalanTasmi: submission.jumlahHafalanTasmi || '-',
                    hasilTasmi: submission.keteranganTasmi?.replace(/_/g, ' ') || '-',
                    tanggalTasmi: submission.timestamp?.toDate().toLocaleDateString('id-ID') || '-',
                    timestamp: submission.timestamp?.toDate() || new Date(0)
                });
            }

            compiledRecapData.sort((a, b) => {
                if (a.namaSantri < b.namaSantri) return -1;
                if (a.namaSantri > b.namaSantri) return 1;
                return a.timestamp - b.timestamp;
            });
        }

        function compileStandardData(submissions) {
            compiledRecapData = [];
            const studentsToProcess = activeClassFilter === 'all' 
                ? allStudents
                : allStudents.filter(s => s.class === activeClassFilter);

            for (const student of studentsToProcess) {
                const studentSubmissions = submissions.filter(s => s.namaSantri1 === student.name || s.namaSantri2 === student.name || s.namaSantri3 === student.name);

                const form1Submissions = studentSubmissions.filter(s => s.formType === 'form1').sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                const latestForm1 = form1Submissions[0] || {};
                
                const form2Submissions = studentSubmissions.filter(s => s.formType === 'form2').sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                const latestForm2 = form2Submissions[0] || {};
                
                const form3Submissions = studentSubmissions.filter(s => s.formType === 'form3');
                const attendance = {
                    alfa: form3Submissions.filter(s => s.kehadiranHalaqoh === 'alpha').length,
                    izin: form3Submissions.filter(s => s.kehadiranHalaqoh === 'izin').length,
                    sakit: form3Submissions.filter(s => s.kehadiranHalaqoh === 'sakit').length,
                };
                
                const itqonScores = form1Submissions.map(s => parseFloat(s.nilaiItqon1)).filter(n => !isNaN(n));
                const tajwidScores = form1Submissions.map(s => parseFloat(s.nilaiTajwid1)).filter(n => !isNaN(n));

                const group = allHalaqohGroups.find(g => g.studentIds?.includes(student.id));
                const mentor = allMentors.find(m => m.id === group?.mentorId);

                compiledRecapData.push({
                    namaSantri: student.name,
                    kelas: student.class || '-',
                    namaPembimbing: mentor?.name || latestForm1.namaPembimbing1 || '-',
                    totalHafalan: latestForm1.totalHafalan1 || '-',
                    hafalanTerakhir: latestForm1.hafalanTerakhir1 || '-',
                    ziyadah: latestForm1.ziyadahPages1 ? `${latestForm1.ziyadahPages1} Halaman` : '-',
                    murojaah: latestForm1.murojaahPages1 ? `${latestForm1.murojaahPages1} Halaman` : '-',
                    nilaiItqon: latestForm1.nilaiItqon1 || '-',
                    nilaiTajwid: latestForm1.nilaiTajwid1 || '-',
                    alfa: attendance.alfa || 0,
                    izin: attendance.izin || 0,
                    sakit: attendance.sakit || 0,
                    jumlahHafalanTasmi: latestForm2.jumlahHafalanTasmi || '-',
                    hasilTasmi: latestForm2.keteranganTasmi?.replace(/_/g, ' ') || '-',
                    tanggalTasmi: latestForm2.timestamp?.toDate().toLocaleDateString('id-ID') || '-',
                    avgItqon: itqonScores.length > 0 ? (itqonScores.reduce((a, b) => a + b, 0) / itqonScores.length).toFixed(2) : '-',
                    avgTajwid: tajwidScores.length > 0 ? (tajwidScores.reduce((a, b) => a + b, 0) / tajwidScores.length).toFixed(2) : '-',
                });
            }
        }

        // --- Table Rendering ---
        function renderTable() {
            dom.rekapLoader.style.display = 'none';
            const view = recapViews[activeRecapFilter];
            if (!view) return;

            dom.rekapTableHead.innerHTML = `<tr>${view.columns.map(col => `<th>${col}</th>`).join('')}</tr>`;
            dom.rekapTableBody.innerHTML = '';

            if (compiledRecapData.length === 0) {
                dom.emptyState.classList.remove('hidden');
                dom.rekapTable.classList.add('hidden');
                dom.exportBtn.disabled = true;
                return;
            }

            dom.emptyState.classList.add('hidden');
            dom.rekapTable.classList.remove('hidden');
            dom.exportBtn.disabled = false;

            let lastStudentName = null;
            let studentCounter = 0;

            if (activeRecapFilter !== 'tasmi') {
                 compiledRecapData.sort((a, b) => a.namaSantri.localeCompare(b.namaSantri));
            }

            compiledRecapData.forEach((data, index) => {
                const row = document.createElement('tr');
                
                if (activeRecapFilter === 'tasmi') {
                    const isSameAsPrevious = data.namaSantri === lastStudentName;
                    if (!isSameAsPrevious) {
                        studentCounter++;
                        lastStudentName = data.namaSantri;
                    }
                    
                    row.innerHTML = `
                        <td>${isSameAsPrevious ? '' : studentCounter}</td>
                        <td style="border-bottom-color: ${isSameAsPrevious ? 'transparent' : '#374151'}">${isSameAsPrevious ? '' : data.namaSantri}</td>
                        <td style="border-bottom-color: ${isSameAsPrevious ? 'transparent' : '#374151'}">${isSameAsPrevious ? '' : data.kelas}</td>
                        <td style="border-bottom-color: ${isSameAsPrevious ? 'transparent' : '#374151'}">${isSameAsPrevious ? '' : data.namaPembimbing}</td>
                        <td>${data.tanggalTasmi}</td>
                        <td>${data.jumlahHafalanTasmi}</td>
                        <td class="capitalize">${data.hasilTasmi}</td>
                    `;
                } else {
                    let rowHTML = `<td>${index + 1}</td>`;
                    view.dataKeys.forEach(key => {
                        rowHTML += `<td class="${key === 'hasilTasmi' ? 'capitalize' : ''}">${data[key] ?? '-'}</td>`;
                    });
                    row.innerHTML = rowHTML;
                }
                dom.rekapTableBody.appendChild(row);
            });
        }


        // --- UI Helpers and Event Listeners ---
        function populateMonthFilter() {
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const now = new Date();
            dom.monthFilter.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth();
                const option = document.createElement('option');
                option.value = `${year}-${month + 1}`;
                option.textContent = `${months[month]} ${year}`;
                dom.monthFilter.appendChild(option);
            }
            dom.monthFilter.value = `${now.getFullYear()}-${now.getMonth() + 1}`;
        }
        
        function populateClassFilterButtons() {
            const container = dom.classFilterContainer;
            container.innerHTML = '<p class="text-gray-400 mr-2">Semua Kelas:</p>';
            
            const allBtn = document.createElement('button');
            allBtn.className = 'btn btn-secondary class-filter-btn';
            allBtn.textContent = 'Semua';
            allBtn.dataset.className = 'all';
            container.appendChild(allBtn);

            allClasses.sort((a, b) => a.name.localeCompare(b.name)).forEach(cls => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-secondary class-filter-btn';
                btn.textContent = cls.name;
                btn.dataset.className = cls.name;
                container.appendChild(btn);
            });
        }

        function exportToExcel() {
            const view = recapViews[activeRecapFilter];
            if (!view || compiledRecapData.length === 0) {
                console.log("Tidak ada data untuk diekspor.");
                return;
            }

            const wb = XLSX.utils.book_new();
            
            // Group current data by class
            const dataByClass = {};
            for (const studentData of compiledRecapData) {
                const className = studentData.kelas || 'Tanpa Kelas';
                if (!dataByClass[className]) {
                    dataByClass[className] = [];
                }
                dataByClass[className].push(studentData);
            }

            const sortedClasses = Object.keys(dataByClass).sort();

            for (const className of sortedClasses) {
                const classData = dataByClass[className];
                const headers = view.columns;
                let rows = [];

                if (activeRecapFilter === 'tasmi') {
                    let lastStudentName = null;
                    let studentCounter = 0;
                    classData.forEach(data => {
                        const isSameAsPrevious = data.namaSantri === lastStudentName;
                        if (!isSameAsPrevious) {
                            studentCounter++;
                            lastStudentName = data.namaSantri;
                        }
                        rows.push([
                            isSameAsPrevious ? '' : studentCounter,
                            isSameAsPrevious ? '' : data.namaSantri,
                            isSameAsPrevious ? '' : data.kelas,
                            isSameAsPrevious ? '' : data.namaPembimbing,
                            data.tanggalTasmi,
                            data.jumlahHafalanTasmi,
                            data.hasilTasmi
                        ]);
                    });
                } else {
                    rows = classData.map((data, index) => {
                        return [index + 1, ...view.dataKeys.map(key => data[key] ?? '-')];
                    });
                }
                
                const sheetData = [headers, ...rows];
                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, className.replace(/[/\\?*:[\]]/g, ''));
            }
            
            let datePart;
            const filterType = document.querySelector('#filterTypeContainer .filter-btn.active').dataset.value;
            if (filterType === 'month') {
                const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                const [year, monthIndex] = dom.monthFilter.value.split('-');
                const monthName = months[parseInt(monthIndex) - 1];
                datePart = `${monthName} ${year}`;
            } else {
                datePart = `${dom.startDateFilter.value} s.d ${dom.endDateFilter.value}`;
            }
            const fileName = `${view.title} - ${datePart}.xlsx`;

            XLSX.writeFile(wb, fileName);
        }
        
        // --- Event Listeners ---
        dom.filterTypeContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.filter-btn');
            if (!target) return;
            
            dom.filterTypeContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');
            
            const filterType = target.dataset.value;

            if (filterType === 'month') {
                dom.dateFilterLabel.textContent = 'Pilih Bulan & Tahun';
                dom.monthFilter.classList.remove('hidden');
                dom.startDateFilter.classList.add('hidden');
                dom.endDateFilter.classList.add('hidden');
            } else {
                dom.dateFilterLabel.textContent = 'Pilih Rentang Tanggal';
                dom.monthFilter.classList.add('hidden');
                dom.startDateFilter.classList.remove('hidden');
                dom.endDateFilter.classList.remove('hidden');
            }
            if (activeClassFilter !== null) fetchRecapData();
        });

        [dom.monthFilter, dom.startDateFilter, dom.endDateFilter].forEach(el => {
            el.addEventListener('change', () => {
                if (activeClassFilter !== null) fetchRecapData();
            });
        });

        dom.exportBtn.addEventListener('click', exportToExcel);
        
        dom.classFilterContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.class-filter-btn');
            if (!target) return;

            dom.classFilterContainer.querySelectorAll('.class-filter-btn').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');

            activeClassFilter = target.dataset.className;
            fetchRecapData();
        });
        
        dom.recapFilterContainer.addEventListener('click', (e) => {
             const target = e.target.closest('.tab-btn');
            if (!target) return;
            
            dom.recapFilterContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');
            
            activeRecapFilter = target.dataset.recap;
            if (activeClassFilter !== null) {
                fetchRecapData();
            } else {
                renderTable();
            }
        });

        // --- Initial Setup ---
        function initializePage() {
            lucide.createIcons();
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 29);
            dom.startDateFilter.value = thirtyDaysAgo.toISOString().split('T')[0];
            dom.endDateFilter.value = today.toISOString().split('T')[0];
            dom.rekapLoader.style.display = 'none';
            dom.emptyState.classList.remove('hidden');
        }

        initializePage();
        window.addEventListener('beforeunload', () => {
            Object.values(unsubscribes).forEach(unsub => unsub && unsub());
        });
    </script>
</body>
</html>
