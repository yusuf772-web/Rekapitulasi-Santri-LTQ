<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapitulasi Data Santri</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SheetJS Library for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        /* Menggunakan gaya yang sama dengan Panel Admin */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }

        .card {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .rekap-table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        .rekap-table th, .rekap-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #374151;
        }

        .rekap-table th {
            background-color: #374151;
            font-weight: 600;
            color: #f9fafb;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .rekap-table tbody tr:hover {
            background-color: #2b3546;
        }

        .form-select, .form-input, .form-checkbox {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #f9fafb;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-select, .form-input {
             padding: 0.625rem 1rem;
             width: 100%;
        }
        .form-checkbox {
            padding: 0.5rem;
            color: #3b82f6;
        }
        .form-checkbox:focus, .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1f2937, 0 0 0 4px #3b82f6;
        }


        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }
        .btn-primary:disabled {
            background-color: #374151;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .btn-secondary {
            background-color: #374151;
            color: #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }
        .btn-danger:disabled {
            background-color: #991b1b;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .class-filter-btn.active {
            background-color: #3b82f6;
            color: white;
        }

        .skeleton-row {
            background-color: #374151;
            border-radius: 0.5rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            height: 49px; /* Match table row height */
            margin-bottom: 8px;
        }
        @keyframes pulse {
            50% {
                opacity: .5;
            }
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1f2937; /* bg-gray-800 */
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }
        
        /* Gaya untuk Toast/Notifikasi */
        .toast {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }
        .toast.show {
            transform: translateX(0);
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i data-lucide="bar-chart-3" class="w-6 h-6 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Rekapitulasi Santri</h1>
            </div>
            <div class="flex items-center gap-4">
                <select id="monthFilter" class="form-select w-full sm:w-48"></select>
                <button id="exportBtn" class="btn btn-primary" disabled>
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    <span>Ekspor</span>
                </button>
                <button id="openDeleteDataModalBtn" class="btn btn-danger">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                    <span>Hapus Data</span>
                </button>
            </div>
        </header>

        <!-- Class Filter Buttons -->
        <div id="classFilterContainer" class="flex flex-wrap items-center gap-2 mb-4">
            <!-- Tombol filter kelas akan dimasukkan di sini oleh JavaScript -->
        </div>

        <!-- Table Card -->
        <div class="card">
            <div class="table-wrapper">
                <div id="rekapLoader" class="p-4">
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                </div>
                <table id="rekapTable" class="rekap-table hidden">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Nama Santri</th>
                            <th>Kelas</th>
                            <th>Nama Pembimbing</th>
                            <th>Total Hafalan</th>
                            <th>Hafalan Terakhir</th>
                            <th>Jml Halaman Ziyadah</th>
                            <th>Jml Halaman Murojaah</th>
                            <th>Nilai Itqon</th>
                            <th>Nilai Tajwid</th>
                            <th>Alfa</th>
                            <th>Izin</th>
                            <th>Sakit</th>
                            <th>Jumlah Hafalan Tasmi</th>
                            <th>Hasil Terakhir Tasmi</th>
                            <th>Tanggal Terakhir Tasmi</th>
                        </tr>
                    </thead>
                    <tbody id="rekapTableBody">
                        <!-- Rows will be injected by JavaScript -->
                    </tbody>
                </table>
                 <div id="emptyState" class="hidden text-center py-16">
                    <i data-lucide="folder-search" class="w-16 h-16 mx-auto text-gray-500"></i>
                    <p class="mt-4 text-lg font-semibold">Tidak Ada Data</p>
                    <p class="text-gray-400">Tidak ada data yang ditemukan untuk filter yang dipilih.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Modal -->
    <div id="deleteDataModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Hapus Data Massal</h3>
                <button id="closeDeleteDataModalBtn" class="p-1 rounded-full hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="deleteDataForm" class="space-y-4">
                <p class="text-sm text-yellow-400 bg-yellow-900/30 p-3 rounded-lg flex items-start gap-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                    <span>Peringatan: Tindakan ini tidak dapat dibatalkan. Data yang dihapus akan hilang secara permanen.</span>
                </p>
                
                <div class="space-y-2">
                    <label class="font-semibold block">Pilih data yang ingin dihapus:</label>
                    <label class="flex items-center gap-2 p-2 rounded-md hover:bg-gray-700/50 cursor-pointer"><input type="checkbox" name="deleteOptions" value="mentors" class="form-checkbox"> Data Pembimbing</label>
                    <label class="flex items-center gap-2 p-2 rounded-md hover:bg-gray-700/50 cursor-pointer"><input type="checkbox" name="deleteOptions" value="classes" class="form-checkbox"> Data Kelas</label>
                    <label class="flex items-center gap-2 p-2 rounded-md hover:bg-gray-700/50 cursor-pointer"><input type="checkbox" name="deleteOptions" value="students" class="form-checkbox"> Data Santri</label>
                    <label class="flex items-center gap-2 p-2 rounded-md hover:bg-gray-700/50 cursor-pointer"><input type="checkbox" name="deleteOptions" value="formSubmissions" class="form-checkbox"> Data Submisi Formulir</label>
                </div>

                <div id="submissionDeleteOptions" class="hidden pl-6 space-y-2 border-l-2 border-gray-600">
                    <label for="deleteTimeRange" class="block text-sm font-medium">Pilih rentang waktu untuk hapus submisi:</label>
                    <select id="deleteTimeRange" class="form-select">
                        <option value="all">Semua Submisi</option>
                        <option value="2m">2 Bulan Terakhir</option>
                        <option value="3m">3 Bulan Terakhir</option>
                        <option value="5m">5 Bulan Terakhir</option>
                        <option value="1y">1 Tahun Terakhir</option>
                    </select>
                </div>

                <div class="pt-2">
                    <label for="deleteConfirmation" class="block font-semibold">Untuk konfirmasi, ketik "HAPUS" di bawah ini:</label>
                    <input type="text" id="deleteConfirmation" class="form-input mt-1" placeholder="HAPUS">
                </div>

                <div class="flex justify-end pt-4">
                    <button type="submit" id="confirmDeleteDataBtn" class="btn btn-danger w-full" disabled>
                        Hapus Data Sekarang
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <p id="toastMessage"></p>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, Timestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBzvOsp5EVnzTI8Kbew9nXSXXLpakBD6Ec",
            authDomain: "ltq-hn.firebaseapp.com",
            projectId: "ltq-hn",
            storageBucket: "ltq-hn.appspot.com",
            messagingSenderId: "542731528480",
            appId: "1:542731528480:web:15203f68716ed2e3dacf45"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let currentUserId = null;
        let unsubscribes = {};
        let allStudents = [];
        let allMentors = [];
        let allHalaqohGroups = [];
        let allClasses = [];
        let compiledRecapData = [];
        let activeClassFilter = 'all';
        let dataReady = { students: false, mentors: false, halaqohGroups: false, classes: false };

        // --- DOM Elements ---
        const dom = {
            monthFilter: document.getElementById('monthFilter'),
            exportBtn: document.getElementById('exportBtn'),
            rekapTable: document.getElementById('rekapTable'),
            rekapTableBody: document.getElementById('rekapTableBody'),
            rekapLoader: document.getElementById('rekapLoader'),
            emptyState: document.getElementById('emptyState'),
            classFilterContainer: document.getElementById('classFilterContainer'),
            openDeleteDataModalBtn: document.getElementById('openDeleteDataModalBtn'),
            deleteDataModal: document.getElementById('deleteDataModal'),
            closeDeleteDataModalBtn: document.getElementById('closeDeleteDataModalBtn'),
            deleteDataForm: document.getElementById('deleteDataForm'),
            submissionDeleteOptions: document.getElementById('submissionDeleteOptions'),
            deleteConfirmation: document.getElementById('deleteConfirmation'),
            confirmDeleteDataBtn: document.getElementById('confirmDeleteDataBtn'),
        };

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                populateMonthFilter();
                preloadData();
            } else {
                try {
                    await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
                } catch (error) {
                    console.error("Authentication error:", error);
                }
            }
        });

        // --- Data Fetching and Processing ---

        function tryFetchRecapData() {
            if (Object.values(dataReady).every(status => status === true)) {
                fetchRecapData();
            }
        }

        function preloadData() {
            const collectionsToLoad = {
                students: 'students',
                mentors: 'mentors',
                halaqohGroups: 'halaqohGroups',
                classes: 'classes'
            };

            Object.entries(collectionsToLoad).forEach(([stateKey, collectionName]) => {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', collectionName));
                unsubscribes[stateKey] = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (stateKey === 'students') allStudents = data;
                    if (stateKey === 'mentors') allMentors = data;
                    if (stateKey === 'halaqohGroups') allHalaqohGroups = data;
                    if (stateKey === 'classes') {
                        allClasses = data;
                        populateClassFilterButtons();
                    }
                    dataReady[stateKey] = true;
                    tryFetchRecapData();
                });
            });
        }

        function fetchRecapData() {
            const [year, month] = dom.monthFilter.value.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);
            
            dom.rekapTable.classList.add('hidden');
            dom.emptyState.classList.add('hidden');
            dom.rekapLoader.style.display = 'block';
            dom.exportBtn.disabled = true;

            const startTimestamp = Timestamp.fromDate(startDate);
            const endTimestamp = Timestamp.fromDate(endDate);

            const submissionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'formSubmissions');
            const q = query(submissionsRef, where('timestamp', '>=', startTimestamp), where('timestamp', '<=', endTimestamp));

            if (unsubscribes.submissions) unsubscribes.submissions();
            unsubscribes.submissions = onSnapshot(q, (snapshot) => {
                const submissions = snapshot.docs.map(doc => doc.data());
                compileData(submissions);
            }, (error) => {
                console.error("Error fetching submissions:", error);
                compileData([]);
            });
        }

        function compileData(submissions) {
            compiledRecapData = [];

            for (const student of allStudents) {
                const studentSubmissions = submissions.filter(s => s.namaSantri1 === student.name || s.namaSantri2 === student.name || s.namaSantri3 === student.name);

                const form1Submissions = studentSubmissions
                    .filter(s => s.formType === 'form1')
                    .sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                const latestForm1 = form1Submissions[0] || {};
                
                const form2Submissions = studentSubmissions
                    .filter(s => s.formType === 'form2')
                    .sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                const latestForm2 = form2Submissions[0] || {};

                const form3Submissions = studentSubmissions.filter(s => s.formType === 'form3');
                const attendance = {
                    alfa: form3Submissions.filter(s => s.kehadiranHalaqoh === 'alpha').length,
                    izin: form3Submissions.filter(s => s.kehadiranHalaqoh === 'izin').length,
                    sakit: form3Submissions.filter(s => s.kehadiranHalaqoh === 'sakit').length,
                };

                const group = allHalaqohGroups.find(g => g.studentIds?.includes(student.id));
                const mentor = allMentors.find(m => m.id === group?.mentorId);

                compiledRecapData.push({
                    namaSantri: student.name,
                    kelas: student.class || '-',
                    namaPembimbing: mentor?.name || latestForm1.namaPembimbing1 || '-',
                    totalHafalan: latestForm1.totalHafalan1 || '-',
                    hafalanTerakhir: latestForm1.hafalanTerakhir1 || '-',
                    ziyadah: latestForm1.ziyadahPages1 ? `${latestForm1.ziyadahPages1} Halaman` : '-',
                    murojaah: latestForm1.murojaahPages1 ? `${latestForm1.murojaahPages1} Halaman` : '-',
                    nilaiItqon: latestForm1.nilaiItqon1 || '-',
                    nilaiTajwid: latestForm1.nilaiTajwid1 || '-',
                    alfa: attendance.alfa || 0,
                    izin: attendance.izin || 0,
                    sakit: attendance.sakit || 0,
                    jumlahHafalanTasmi: latestForm2.jumlahHafalanTasmi || '-',
                    hasilTasmi: latestForm2.keteranganTasmi?.replace(/_/g, ' ') || '-',
                    tanggalTasmi: latestForm2.timestamp?.toDate().toLocaleDateString('id-ID') || '-',
                });
            }
            renderTable();
        }

        function renderTable() {
            dom.rekapLoader.style.display = 'none';
            dom.rekapTableBody.innerHTML = '';

            let dataToRender = compiledRecapData;
            if (activeClassFilter !== 'all') {
                dataToRender = compiledRecapData.filter(data => data.kelas === activeClassFilter);
            }

            if (dataToRender.length === 0) {
                dom.emptyState.classList.remove('hidden');
                dom.rekapTable.classList.add('hidden');
                dom.exportBtn.disabled = true;
                return;
            }

            dom.emptyState.classList.add('hidden');
            dom.rekapTable.classList.remove('hidden');
            dom.exportBtn.disabled = false;

            dataToRender.sort((a, b) => a.namaSantri.localeCompare(b.namaSantri));
            
            dataToRender.forEach((data, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${data.namaSantri}</td>
                        <td>${data.kelas}</td>
                        <td>${data.namaPembimbing}</td>
                        <td>${data.totalHafalan}</td>
                        <td>${data.hafalanTerakhir}</td>
                        <td>${data.ziyadah}</td>
                        <td>${data.murojaah}</td>
                        <td>${data.nilaiItqon}</td>
                        <td>${data.nilaiTajwid}</td>
                        <td>${data.alfa}</td>
                        <td>${data.izin}</td>
                        <td>${data.sakit}</td>
                        <td>${data.jumlahHafalanTasmi}</td>
                        <td class="capitalize">${data.hasilTasmi}</td>
                        <td>${data.tanggalTasmi}</td>
                    </tr>
                `;
                dom.rekapTableBody.innerHTML += row;
            });
        }

        // --- UI Helpers and Event Listeners ---
        function populateMonthFilter() {
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth();
                const option = document.createElement('option');
                option.value = `${year}-${month + 1}`;
                option.textContent = `${months[month]} ${year}`;
                dom.monthFilter.appendChild(option);
            }
        }
        
        function populateClassFilterButtons() {
            const container = dom.classFilterContainer;
            container.innerHTML = '';

            const allBtn = document.createElement('button');
            allBtn.className = 'btn btn-secondary class-filter-btn active';
            allBtn.textContent = 'Semua Kelas';
            allBtn.dataset.className = 'all';
            container.appendChild(allBtn);

            allClasses.sort((a, b) => a.name.localeCompare(b.name)).forEach(cls => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-secondary class-filter-btn';
                btn.textContent = cls.name;
                btn.dataset.className = cls.name;
                container.appendChild(btn);
            });
        }

        function exportToExcel() {
            const dataToExport = [...compiledRecapData];
            if (dataToExport.length === 0) return;

            dataToExport.sort((a, b) => {
                if (a.kelas < b.kelas) return -1;
                if (a.kelas > b.kelas) return 1;
                return a.namaSantri.localeCompare(b.namaSantri);
            });

            const wb = XLSX.utils.book_new();

            const dataByClass = {};
            for (const studentData of dataToExport) {
                const className = studentData.kelas || 'Tanpa Kelas';
                if (!dataByClass[className]) {
                    dataByClass[className] = [];
                }
                dataByClass[className].push(studentData);
            }

            const headers = ["No", "Nama Santri", "Kelas", "Nama Pembimbing", "Total Hafalan", "Hafalan Terakhir", "Jml Halaman Ziyadah", "Jml Halaman Murojaah", "Nilai Itqon", "Nilai Tajwid", "Alfa", "Izin", "Sakit", "Jumlah Hafalan Tasmi", "Hasil Terakhir Tasmi", "Tanggal Terakhir Tasmi"];
            
            const sortedClasses = Object.keys(dataByClass).sort();

            for (const className of sortedClasses) {
                const classData = dataByClass[className];
                
                const rows = classData.map((d, i) => [
                    i + 1, d.namaSantri, d.kelas, d.namaPembimbing, d.totalHafalan, d.hafalanTerakhir,
                    d.ziyadah, d.murojaah, d.nilaiItqon, d.nilaiTajwid,
                    d.alfa, d.izin, d.sakit, d.jumlahHafalanTasmi, d.hasilTasmi, d.tanggalTasmi
                ]);

                const sheetData = [headers, ...rows];
                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, className);
            }

            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const [year, monthIndex] = dom.monthFilter.value.split('-');
            const monthName = months[parseInt(monthIndex) - 1];
            const fileName = `Rekap Santri - ${monthName} ${year}.xlsx`;

            XLSX.writeFile(wb, fileName);
        }

        // --- Toast Notification Function (FIX) ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toast || !toastMessage) return;

            toastMessage.textContent = message;
            toast.className = `toast ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- Modal Functions ---
        function openDeleteDataModal() {
            dom.deleteDataModal.classList.add('visible');
        }

        function closeDeleteDataModal() {
            dom.deleteDataModal.classList.remove('visible');
            dom.deleteDataForm.reset();
            dom.submissionDeleteOptions.classList.add('hidden');
            dom.confirmDeleteDataBtn.disabled = true;
            dom.confirmDeleteDataBtn.innerHTML = 'Hapus Data Sekarang';
        }

        // --- Bulk Delete Function (FIXED) ---
        async function handleBulkDelete(e) {
            e.preventDefault();
            const collectionsToDelete = Array.from(document.querySelectorAll('input[name="deleteOptions"]:checked')).map(cb => cb.value);
            
            if (collectionsToDelete.length === 0) {
                showToast("Pilih setidaknya satu jenis data untuk dihapus.", true);
                return;
            }

            const button = dom.confirmDeleteDataBtn;
            const originalButtonHTML = button.innerHTML;
            
            // Set loading state
            button.disabled = true;
            button.innerHTML = `
                <div class="flex items-center justify-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Menghapus...</span>
                </div>
            `;

            try {
                let totalDeleted = 0;
                let errors = [];

                for (const collectionName of collectionsToDelete) {
                    let q = collection(db, 'artifacts', appId, 'public', 'data', collectionName);

                    if (collectionName === 'formSubmissions') {
                        const range = document.getElementById('deleteTimeRange').value;
                        if (range !== 'all') {
                            const now = new Date();
                            let startDate;
                            if (range.endsWith('m')) {
                                startDate = new Date(now.setMonth(now.getMonth() - parseInt(range)));
                            } else if (range.endsWith('y')) {
                                startDate = new Date(now.setFullYear(now.getFullYear() - parseInt(range)));
                            }
                            // Hapus data yang LEBIH LAMA dari tanggal yang ditentukan
                            q = query(q, where('timestamp', '<=', Timestamp.fromDate(startDate)));
                        }
                    }
                    
                    try {
                        const snapshot = await getDocs(q);
                        if (snapshot.size > 0) {
                           const batch = writeBatch(db);
                           snapshot.docs.forEach(doc => batch.delete(doc.ref));
                           await batch.commit();
                           totalDeleted += snapshot.size;
                        }
                    } catch (err) {
                        console.error(`Error deleting collection ${collectionName}:`, err);
                        errors.push(collectionName);
                    }
                }

                if (errors.length > 0) {
                    showToast(`Gagal menghapus beberapa data: ${errors.join(', ')}.`, true);
                }
                if (totalDeleted > 0) {
                    showToast(`${totalDeleted} item berhasil dihapus secara permanen.`);
                }
                if (totalDeleted === 0 && errors.length === 0) {
                     showToast(`Tidak ada data yang cocok untuk dihapus.`);
                }
                
                closeDeleteDataModal();

            } catch (error) {
                console.error("An unexpected error occurred during deletion:", error);
                showToast("Terjadi kesalahan yang tidak terduga.", true);
            } finally {
                // ALWAYS reset the button state, no matter what happens
                button.disabled = false;
                button.innerHTML = originalButtonHTML;
            }
        }
        
        // --- Event Listeners ---
        dom.monthFilter.addEventListener('change', fetchRecapData);
        dom.exportBtn.addEventListener('click', exportToExcel);
        dom.classFilterContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.class-filter-btn');
            if (!target) return;

            dom.classFilterContainer.querySelectorAll('.class-filter-btn').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');

            activeClassFilter = target.dataset.className;
            renderTable();
        });

        dom.openDeleteDataModalBtn.addEventListener('click', openDeleteDataModal);
        dom.closeDeleteDataModalBtn.addEventListener('click', closeDeleteDataModal);
        dom.deleteDataForm.addEventListener('submit', handleBulkDelete);
        
        document.querySelector('input[value="formSubmissions"]').addEventListener('change', (e) => {
            dom.submissionDeleteOptions.classList.toggle('hidden', !e.target.checked);
        });

        dom.deleteConfirmation.addEventListener('input', (e) => {
            dom.confirmDeleteDataBtn.disabled = e.target.value.trim() !== 'HAPUS';
        });

        // --- Final Setup ---
        lucide.createIcons();
        
        window.addEventListener('beforeunload', () => {
            Object.values(unsubscribes).forEach(unsub => unsub && unsub());
        });
    </script>
</body>
</html>
